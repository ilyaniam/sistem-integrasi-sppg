<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Integrasi Gizi (SIG) - Anti-Fraud Framework</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-slate-100 font-sans">

    <header class="bg-slate-900 text-white p-4 shadow-xl sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight">SIG INTEGRASI - SPPG KLEGO</h1>
                <p class="text-xs text-slate-400">Framework: Locked Price & Blind Receiving Enabled</p>
            </div>
            <div class="flex items-center gap-4">
                <span class="bg-green-500/20 text-green-400 border border-green-500 px-3 py-1 rounded-full text-xs font-mono">DB Sync: OK</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

        <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-2 mb-4 text-orange-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor font-bold">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                <h2 class="font-bold uppercase tracking-wider text-sm">Modul Supply Chain</h2>
            </div>
            
            <div class="space-y-4">
                <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                    <p class="text-xs text-orange-700 font-semibold mb-1 uppercase">Stok Koperasi (e-Catalog)</p>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div><p class="text-[10px] text-orange-500">Beras</p><p id="stok-Beras" class="font-bold">500</p></div>
                        <div><p class="text-[10px] text-orange-500">Ayam</p><p id="stok-Ayam" class="font-bold">100</p></div>
                        <div><p class="text-[10px] text-orange-500">Telur</p><p id="stok-Telur" class="font-bold">200</p></div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">PILIH BAHAN (LOCKED PRICE)</label>
                    <select id="item-select" class="w-full border-2 border-slate-100 p-2.5 rounded-xl bg-slate-50 focus:border-orange-400 outline-none transition-all">
                        <option value="Beras">Beras (Rp 13.000/kg)</option>
                        <option value="Ayam">Daging Ayam (Rp 35.000/kg)</option>
                        <option value="Telur">Telur Ayam (Rp 28.000/kg)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Input Jumlah Penerima</label>
                    <input type="number" id="jml-penerima" placeholder="Contoh: 100 anak" class="w-full border-2 border-slate-100 p-2.5 rounded-xl outline-none focus:border-orange-400">
                    <p class="text-[10px] text-slate-400 mt-1">*Sistem akan menghitung otomatis berdasarkan gramasi menu.</p>
                </div>

                <button onclick="buatPOOtomatis()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-200 transition-all uppercase text-sm">Generate PO Otomatis</button>
            </div>
        </section>

        <section class="lg:col-span-2 bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2 text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h2 class="font-bold uppercase tracking-wider text-sm">Blind Receiving & Digital Scale</h2>
                </div>
                <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded-md font-bold italic">SOP: Selisih > 2% = Red Flag</span>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="text-slate-400 border-b">
                            <th class="pb-3 font-semibold">Item Datang</th>
                            <th class="pb-3 font-semibold">Input Timbangan (IoT)</th>
                            <th class="pb-3 font-semibold">Bukti Kondisi</th>
                            <th class="pb-3 font-semibold">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="list-verifikasi" class="divide-y divide-slate-50">
                        <tr><td colspan="4" class="py-10 text-center text-slate-300 italic text-xs">Menunggu PO dari SPPG...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="lg:col-span-3 bg-slate-900 text-slate-300 p-6 rounded-3xl shadow-2xl">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <div>
                    <h2 class="text-white font-bold text-lg flex items-center gap-2">
                        <span class="flex h-3 w-3 rounded-full bg-red-500"></span>
                        Executive Dashboard (Owner Monitoring)
                    </h2>
                    <p class="text-xs text-slate-500">Real-time Variance Analysis & Fraud Detection</p>
                </div>
                <div class="bg-slate-800 p-3 rounded-2xl border border-slate-700">
                    <p class="text-[10px] uppercase font-bold text-slate-500">Real Food Cost (Verified)</p>
                    <p id="total-cost" class="text-xl font-mono text-green-400 font-bold">Rp 0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
                    <p class="text-xs font-bold text-slate-400 mb-3 uppercase tracking-widest">Digital Audit Trail</p>
                    <div id="log-audit" class="space-y-3 h-64 overflow-y-auto pr-2 custom-scrollbar">
                        </div>
                </div>

                <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50">
                    <p class="text-xs font-bold text-red-400 mb-3 uppercase tracking-widest">Anomaly Detection (Alerts)</p>
                    <div id="anomaly-alerts" class="space-y-3">
                        <div class="text-xs text-slate-500 italic">No anomalies detected...</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row items-center gap-8">
            <div class="bg-slate-50 p-4 rounded-2xl border-2 border-dashed border-slate-200 text-center">
                <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">Unique QR ID per Box</p>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=SIG-Klego-Verified" class="mx-auto rounded-lg shadow-md">
            </div>
            <div class="flex-1 space-y-4 w-full">
                <h3 class="font-bold text-slate-800 uppercase text-sm">Konfirmasi Penerima Manfaat</h3>
                <div class="flex gap-2">
                    <input id="feedback-text" type="text" placeholder="Masukkan ulasan kualitas gizi (porsi, rasa, kebersihan)..." class="flex-1 border-2 border-slate-100 p-3 rounded-xl focus:border-purple-400 outline-none transition-all text-sm">
                    <button onclick="kirimFeedback('Puas')" class="bg-purple-600 text-white px-6 rounded-xl font-bold text-sm hover:bg-purple-700 transition-all">Kirim Feedback</button>
                </div>
                <div class="flex gap-4">
                    <div class="flex items-center gap-2">
                        <span class="h-2 w-2 rounded-full bg-green-500"></span>
                        <p class="text-[10px] text-slate-500">Data terintegrasi NIK Kependudukan</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="h-2 w-2 rounded-full bg-blue-500"></span>
                        <p class="text-[10px] text-slate-500">Geo-tagged Evidence Enabled</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        // DATA DASAR (LOCKED PRICE & GRAMASI)
        const MASTER_DATA = {
            Beras: { harga: 13000, gramasi: 150, stok: 500 }, // 150gr per anak
            Ayam: { harga: 35000, gramasi: 100, stok: 100 },  // 100gr per anak
            Telur: { harga: 28000, gramasi: 60, stok: 200 }   // 60gr per anak
        };

        let pendingOrders = [];
        let totalCost = 0;

        // 1. AUTOMATIC PO GENERATOR
        function buatPOOtomatis() {
            const item = document.getElementById('item-select').value;
            const jmlPenerima = parseInt(document.getElementById('jml-penerima').value);

            if (!jmlPenerima || jmlPenerima <= 0) {
                Swal.fire('Input Error', 'Masukkan jumlah penerima manfaat!', 'error');
                return;
            }

            const targetQty = (jmlPenerima * MASTER_DATA[item].gramasi) / 1000; // Konversi ke KG
            
            if (targetQty > MASTER_DATA[item].stok) {
                Swal.fire('Stok Kurang', `Stok ${item} di Koperasi hanya ${MASTER_DATA[item].stok}kg`, 'warning');
                return;
            }

            const order = {
                id: Date.now(),
                item: item,
                targetQty: targetQty,
                hargaSatuan: MASTER_DATA[item].harga,
                status: 'In-Transit'
            };

            pendingOrders.push(order);
            MASTER_DATA[item].stok -= targetQty; // Reservasi stok
            
            updateStokVisual();
            renderVerifikasi();
            tambahLog('SPPG SYSTEM', `PO Otomatis dibuat: ${targetQty}kg ${item} untuk ${jmlPenerima} penerima.`, '-', 'Generated');
            
            document.getElementById('jml-penerima').value = '';
        }

        // 2. BLIND RECEIVING & QC
        function renderVerifikasi() {
            const container = document.getElementById('list-verifikasi');
            if (pendingOrders.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="py-10 text-center text-slate-300 italic text-xs">Menunggu PO dari SPPG...</td></tr>';
                return;
            }

            container.innerHTML = pendingOrders.map(order => `
                <tr class="group hover:bg-slate-50 transition-all">
                    <td class="py-4 font-bold text-slate-700">${order.item}</td>
                    <td class="py-4">
                        <div class="flex items-center gap-2">
                            <input type="number" id="input-weight-${order.id}" placeholder="Input kg..." class="w-24 border-2 border-slate-200 p-1.5 rounded-lg text-sm focus:border-blue-400 outline-none">
                            <span class="text-[10px] text-blue-500 font-bold">IoT SCALE</span>
                        </div>
                    </td>
                    <td class="py-4">
                        <input type="file" class="text-[10px] text-slate-400">
                    </td>
                    <td class="py-4 space-x-1 flex">
                        <button onclick="verifikasiPenerimaan(${order.id})" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase">Verifikasi</button>
                        <button onclick="returnBarang(${order.id})" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase hover:bg-red-600 hover:text-white transition-all">Return</button>
                    </td>
                </tr>
            `).join('');
        }

        function verifikasiPenerimaan(id) {
            const order = pendingOrders.find(o => o.id === id);
            const actualQty = parseFloat(document.getElementById(`input-weight-${id}`).value);

            if (!actualQty) {
                Swal.fire('Audit Alert', 'Wajib input berat dari timbangan IoT!', 'warning');
                return;
            }

            // BLIND RECEIVING LOGIC: Cek selisih > 2%
            const diff = Math.abs(actualQty - order.targetQty) / order.targetQty;
            const finalPrice = actualQty * order.hargaSatuan;

            if (diff > 0.02) {
                kirimAlertAnomaly(`SELISIH TIMBANGAN: ${order.item} selisih ${(diff * 100).toFixed(1)}%. Target: ${order.targetQty}kg, Aktual: ${actualQty}kg.`);
                tambahLog('SECURITY', `ANOMALI DETECTED: Selisih berat pada ${order.item}`, '-', 'RED FLAG');
            }

            totalCost += finalPrice;
            document.getElementById('total-cost').innerText = `Rp ${totalCost.toLocaleString('id-ID')}`;
            
            tambahLog('QC & GUDANG', `Verifikasi selesai: ${actualQty}kg ${order.item} diterima.`, `Rp ${finalPrice.toLocaleString()}`, 'Verified');
            
            pendingOrders = pendingOrders.filter(o => o.id !== id);
            renderVerifikasi();
            Swal.fire('Berhasil', 'Data terverifikasi & Audit trail diperbarui.', 'success');
        }

        function returnBarang(id) {
            const order = pendingOrders.find(o => o.id === id);
            MASTER_DATA[order.item].stok += order.targetQty; // Kembalikan stok koperasi
            
            updateStokVisual();
            tambahLog('SPPG QC', `REAL-TIME RETURN: ${order.item} dikembalikan (Tidak Layak/Rusak).`, 'Rp 0', 'RETURNED');
            
            pendingOrders = pendingOrders.filter(o => o.id !== id);
            renderVerifikasi();
            Swal.fire('Return Berhasil', 'Tagihan koperasi otomatis dipotong/dibatalkan.', 'error');
        }

        // 3. UTILS & MONITORING
        function tambahLog(pihak, aktivitas, biaya, status) {
            const logTable = document.getElementById('log-audit');
            const div = document.createElement('div');
            div.className = "flex justify-between items-start p-3 bg-slate-800 rounded-xl border-l-4 " + 
                            (status === 'RED FLAG' ? 'border-red-500' : 'border-blue-500');
            
            div.innerHTML = `
                <div>
                    <p class="text-[10px] text-slate-500 font-mono">${new Date().toLocaleTimeString()} - ${pihak}</p>
                    <p class="text-xs text-slate-200">${aktivitas}</p>
                </div>
                <div class="text-right">
                    <p class="text-xs font-bold text-green-400">${biaya}</p>
                    <p class="text-[9px] font-bold uppercase ${status === 'RED FLAG' ? 'text-red-500' : 'text-slate-500'}">${status}</p>
                </div>
            `;
            logTable.prepend(div);
        }

        function kirimAlertAnomaly(msg) {
            const container = document.getElementById('anomaly-alerts');
            if (container.innerText.includes('No anomalies')) container.innerHTML = '';
            
            const div = document.createElement('div');
            div.className = "p-3 bg-red-900/30 border border-red-500/50 rounded-xl text-red-200 text-[10px] animate-bounce";
            div.innerHTML = `<strong>⚠️ RED FLAG:</strong> ${msg}`;
            container.prepend(div);
        }

        function kirimFeedback(status) {
            const teks = document.getElementById('feedback-text').value;
            tambahLog('PENERIMA', `FEEDBACK: ${teks || 'Puas dengan pelayanan'}`, '-', 'Rating: 5/5');
            Swal.fire('Diterima', 'Feedback terintegrasi ke KPI SPPG.', 'info');
            document.getElementById('feedback-text').value = '';
        }

        function updateStokVisual
