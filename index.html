<script>
        // DATA DASAR (LOCKED PRICE & GRAMASI TETAP)
        const MASTER_DATA = {
            Beras: { harga: 13000, gramasi: 150, stok: 500 }, 
            Ayam: { harga: 35000, gramasi: 100, stok: 100 },  
            Telur: { harga: 28000, gramasi: 60, stok: 200 }   
        };

        let pendingOrders = [];
        let totalCost = 0;

        // 1. AUTOMATIC PO GENERATOR (FIXED)
        function buatPOOtomatis() {
            const itemElement = document.getElementById('item-select');
            const jmlPenerimaElement = document.getElementById('jml-penerima');
            
            const item = itemElement.value;
            const jmlPenerima = parseInt(jmlPenerimaElement.value);

            // Validasi Input
            if (isNaN(jmlPenerima) || jmlPenerima <= 0) {
                Swal.fire('Input Error', 'Silakan masukkan jumlah penerima manfaat yang valid!', 'error');
                return;
            }

            // Hitung otomatis berdasarkan gramasi standar
            const targetQty = (jmlPenerima * MASTER_DATA[item].gramasi) / 1000; 
            
            // Cek Stok Koperasi
            if (targetQty > MASTER_DATA[item].stok) {
                Swal.fire('Stok Kurang', `Stok ${item} tidak cukup untuk kebutuhan ${targetQty.toFixed(1)}kg.`, 'warning');
                return;
            }

            const order = {
                id: Date.now(),
                item: item,
                targetQty: targetQty,
                hargaSatuan: MASTER_DATA[item].harga,
                status: 'In-Transit'
            };

            pendingOrders.push(order);
            MASTER_DATA[item].stok -= targetQty; // Potong stok real-time
            
            updateStokVisual();
            renderVerifikasi();
            
            tambahLog('SPPG SYSTEM', `PO GENERATED: ${targetQty.toFixed(1)}kg ${item} untuk ${jmlPenerima} anak.`, '-', 'Generated');
            
            // Bersihkan input
            jmlPenerimaElement.value = '';
            Swal.fire('PO Berhasil', `Pesanan ${targetQty.toFixed(1)}kg ${item} telah diteruskan ke Koperasi.`, 'success');
        }

        // 2. BLIND RECEIVING & DOUBLE VERIFICATION
        function renderVerifikasi() {
            const container = document.getElementById('list-verifikasi');
            if (pendingOrders.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="py-10 text-center text-slate-300 italic text-xs">Menunggu PO dari SPPG...</td></tr>';
                return;
            }

            container.innerHTML = pendingOrders.map(order => `
                <tr class="group hover:bg-slate-50 transition-all border-b border-slate-100">
                    <td class="py-4 font-bold text-slate-700 uppercase text-xs">${order.item}</td>
                    <td class="py-4">
                        <div class="flex items-center gap-2">
                            <input type="number" id="input-weight-${order.id}" placeholder="KG Riil" class="w-20 border-2 border-slate-200 p-1 rounded-md text-xs focus:border-blue-400 outline-none">
                            <span class="text-[9px] text-blue-500 font-bold leading-none">IoT<br>SCALE</span>
                        </div>
                    </td>
                    <td class="py-4 text-center">
                        <div class="flex flex-col gap-1">
                            <input type="file" class="text-[9px] text-slate-400 w-32">
                            <label class="inline-flex items-center text-[9px] text-slate-500 italic">
                                <input type="checkbox" id="sign-${order.id}" class="mr-1"> Double Sign OK
                            </label>
                        </div>
                    </td>
                    <td class="py-4 space-x-1 flex justify-end">
                        <button onclick="verifikasiPenerimaan(${order.id})" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase hover:bg-blue-700 shadow-sm">Verifikasi</button>
                        <button onclick="returnBarang(${order.id})" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase hover:bg-red-600 hover:text-white transition-all">Return</button>
                    </td>
                </tr>
            `).join('');
        }

        function verifikasiPenerimaan(id) {
            const doubleSign = document.getElementById(`sign-${id}`).checked;
            if (!doubleSign) {
                Swal.fire('SOP Alert', 'Wajib checklist Double Signature (Petugas & QC)!', 'warning');
                return;
            }

            const order = pendingOrders.find(o => o.id === id);
            const weightInput = document.getElementById(`input-weight-${id}`);
            const actualQty = parseFloat(weightInput.value);

            if (isNaN(actualQty) || actualQty <= 0) {
                Swal.fire('Audit Alert', 'Input berat riil dari timbangan IoT!', 'warning');
                return;
            }

            // BLIND RECEIVING LOGIC: Cek selisih > 2%
            const diff = Math.abs(actualQty - order.targetQty) / order.targetQty;
            const finalPrice = actualQty * order.hargaSatuan;

            if (diff > 0.02) {
                kirimAlertAnomaly(`SELISIH TIMBANGAN: ${order.item} selisih ${(diff * 100).toFixed(1)}% dari target ${order.targetQty.toFixed(1)}kg.`);
                tambahLog('SECURITY', `ANOMALI: Selisih berat ${order.item} (${(diff * 100).toFixed(1)}%)`, '-', 'RED FLAG');
            }

            totalCost += finalPrice;
            document.getElementById('total-cost').innerText = `Rp ${totalCost.toLocaleString('id-ID')}`;
            
            tambahLog('QC & GUDANG', `Verified: ${actualQty}kg ${order.item} diterima.`, `Rp ${finalPrice.toLocaleString()}`, 'Verified');
            
            pendingOrders = pendingOrders.filter(o => o.id !== id);
            renderVerifikasi();
            Swal.fire('Berhasil', 'Penerimaan terverifikasi dan masuk Audit Trail.', 'success');
        }

        function returnBarang(id) {
            const order = pendingOrders.find(o => o.id === id);
            MASTER_DATA[order.item].stok += order.targetQty; 
            
            updateStokVisual();
            tambahLog('SPPG QC', `RETURN: ${order.item} dikembalikan. Tagihan dibatalkan.`, 'Rp 0', 'RETURNED');
            
            pendingOrders = pendingOrders.filter(o => o.id !== id);
            renderVerifikasi();
            Swal.fire('Return Berhasil', 'Data stok dikembalikan ke Koperasi.', 'error');
        }

        // 3. UTILS
        function updateStokVisual() {
            for (let key in MASTER_DATA) {
                const el = document.getElementById(`stok-${key}`);
                if (el) el.innerText = MASTER_DATA[key].stok.toFixed(1);
            }
        }

        function tambahLog(pihak, aktivitas, biaya, status) {
            const logTable = document.getElementById('log-audit');
            const div = document.createElement('div');
            const isRedFlag = status === 'RED FLAG';
            
            div.className = `flex justify-between items-start p-3 bg-slate-800 rounded-xl border-l-4 ${isRedFlag ? 'border-red-500 animate-pulse' : 'border-blue-500'}`;
            
            div.innerHTML = `
                <div>
                    <p class="text-[9px] text-slate-500 font-mono">${new Date().toLocaleTimeString()} - ${pihak}</p>
                    <p class="text-xs ${isRedFlag ? 'text-red-400 font-bold' : 'text-slate-200'}">${aktivitas}</p>
                </div>
                <div class="text-right">
                    <p class="text-xs font-bold text-green-400">${biaya}</p>
                    <p class="text-[9px] font-bold uppercase ${isRedFlag ? 'text-red-500' : 'text-slate-500'}">${status}</p>
                </div>
            `;
            logTable.prepend(div);
        }

        function kirimAlertAnomaly(msg) {
            const container = document.getElementById('anomaly-alerts');
            if (container.innerText.includes('No anomalies')) container.innerHTML = '';
            
            const div = document.createElement('div');
            div.className = "p-3 bg-red-900/40 border border-red-500 rounded-xl text-red-100 text-[10px] shadow-lg mb-2";
            div.innerHTML = `<strong>ðŸš¨ ANOMALI SISTEM:</strong> ${msg}`;
            container.prepend(div);
        }

        function kirimFeedback(status) {
            const teks = document.getElementById('feedback-text').value;
            tambahLog('PENERIMA', `FEEDBACK: ${teks || 'Konfirmasi Terima Makanan'}`, '-', 'Rating: â˜…â˜…â˜…â˜…â˜…');
            Swal.fire('Terkirim', 'Ulasan gizi masuk ke dashboard pengawasan.', 'info');
            document.getElementById('feedback-text').value = '';
        }
    </script>
